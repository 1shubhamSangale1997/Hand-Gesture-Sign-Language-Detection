from flask import Flask, render_template, Response
import cv2
import cv2
import numpy as np

def nothing(x):
    pass

image_x, image_y = 64,64

from tensorflow.keras.models import load_model
clas = load_model('Trained_model.h5')

cv2.namedWindow("Trackbars")

cv2.createTrackbar("L - H", "Trackbars", 0, 179, nothing)
cv2.createTrackbar("L - S", "Trackbars", 0, 255, nothing)
cv2.createTrackbar("L - V", "Trackbars", 0, 255, nothing)
cv2.createTrackbar("U - H", "Trackbars", 179, 179, nothing)
cv2.createTrackbar("U - S", "Trackbars", 255, 255, nothing)
cv2.createTrackbar("U - V", "Trackbars", 255, 255, nothing)

#cv2.namedWindow("test")

img_counter = 0

img_text = ''
app = Flask(__name__)

camera = cv2.VideoCapture(0)  # use 0 for web camera
#  for cctv camera use rtsp://username:password@ip_address:554/user=username_password='password'_channel=channel_number_stream=0.sdp' instead of camera
# for local webcam use cv2.VideoCapture(0)

def gen_frames():  # generate frame by frame from camera
    img_text = ''
    from tensorflow.keras.models import load_model
    clas = load_model('Trained_model.h5')
    def predictor():
       import numpy as np
       from tensorflow.keras.preprocessing import image
       


       test_image = image.load_img('1.png', target_size=(64, 64))
       test_image = image.img_to_array(test_image)
       test_image = np.expand_dims(test_image, axis = 0)
       #print(classifier)
       
       result = clas.predict(test_image)
       
       if result[0][0] == 1:
              return 'Be My Friend'
       elif result[0][1] == 1:
              return 'Donot Worry'
       elif result[0][2] == 1:
              return 'Get well soon'
       elif result[0][3] == 1:
              return 'Give Me Water'
       elif result[0][4] == 1:
              return 'Good Morning'
       elif result[0][5] == 1:
              return 'Good Night'
       elif result[0][6] == 1:
              return 'Help Me'
       elif result[0][7] == 1:
              return 'How are You'
       elif result[0][8] == 1:
              return 'Hungry'
       elif result[0][9] == 1:
              return 'Hurry Up'
       elif result[0][10] == 1:
              return 'I am Fine'
       elif result[0][11] == 1:
              return 'I am Late'
       elif result[0][12] == 1:
              return 'I am Not Feeling Well'
       elif result[0][13] == 1:
              return 'I am Tired'
       elif result[0][14] == 1:
              return 'I Love Reading'
       elif result[0][15] == 1:
              return 'I Love Writing'
       elif result[0][16] == 1:
              return 'I will Try my level Best'
       elif result[0][17] == 1:
              return 'Its Raining Outside'
       elif result[0][18] == 1:
              return 'Lets Dance'
       elif result[0][19] == 1:
              return 'Lets Go'
       elif result[0][20] == 1:
              return 'Lets Play'
       elif result[0][21] == 1:
              return 'Long Time no See'
       elif result[0][22] == 1:
              return 'Look Down'
       elif result[0][23] == 1:
              return 'Look Up'
       elif result[0][24] == 1:
              return 'Medicine'
       elif result[0][25] == 1:
              return 'Music'
       elif result[0][26] == 1:
              return 'Nice to Meet you'
       elif result[0][27] == 1:
              return 'So kind of you'
       elif result[0][28] == 1:
              return 'Sorry'
       elif result[0][29] == 1:
              return 'Study Time'
       elif result[0][30] == 1:
              return 'Thank You'
       elif result[0][31] == 1:
              return 'Washroom'
       elif result[0][32] == 1:
              return 'Watch Out'
       elif result[0][33] == 1:
              return 'Weather is beautiful outside'
       elif result[0][34] == 1:
              return 'Well Done'
       elif result[0][35] == 1:
              return 'Will you join Me'
       elif result[0][36] == 1:
              return 'Wonderful'
       elif result[0][37] == 1:
              return 'You are Beautiful'
       elif result[0][38] == 1:
              return 'You will be Fine'

    while True:
        # Capture frame-by-frame
        success, frame = camera.read()  # read the camera frame
        
        #print('k')
        frame = cv2.flip(frame,1)
        l_h = cv2.getTrackbarPos("L - H", "Trackbars")
        l_s = cv2.getTrackbarPos("L - S", "Trackbars")
        l_v = cv2.getTrackbarPos("L - V", "Trackbars")
        u_h = cv2.getTrackbarPos("U - H", "Trackbars")
        u_s = cv2.getTrackbarPos("U - S", "Trackbars")
        u_v = cv2.getTrackbarPos("U - V", "Trackbars")


        img = cv2.rectangle(frame, (425,100),(625,300), (0,255,0), thickness=2, lineType=8, shift=0)

        lower_blue = np.array([0,10,60])
        upper_blue = np.array([20,150,255])
        imcrop = img[102:298, 427:623]
        hsv = cv2.cvtColor(imcrop, cv2.COLOR_BGR2HSV)
        mask = cv2.inRange(hsv, lower_blue, upper_blue)
        
        cv2.putText(frame, img_text, (30, 400), cv2.FONT_HERSHEY_TRIPLEX, 1.5, (0, 255, 0))
        #cv2.imshow("test", frame)
        cv2.imshow("mask", mask)
        
        #if cv2.waitKey(1) == ord('c'):
        #print('kk')
        img_name = "1.png"
        save_img = cv2.resize(mask, (image_x, image_y))
        cv2.imwrite(img_name, save_img)
        #print("{} written!".format(img_name))
        img_text = predictor()
        ret, buffer = cv2.imencode('.jpg', frame)
        
        frame = buffer.tobytes()
        yield (b'--frame\r\n'
               b'Content-Type: image/jpeg\r\n\r\n' + frame + b'\r\n')  # concat frame one by one and show result
        if cv2.waitKey(1) == 27:
            break

@app.route('/video_feed')
def video_feed():
    #Video streaming route. Put this in the src attribute of an img tag
    return Response(gen_frames(), mimetype='multipart/x-mixed-replace; boundary=frame')


@app.route('/')
def index():
    """Video streaming home page."""
    return render_template('index.html')


if __name__ == '__main__':
    app.run(debug=False)
